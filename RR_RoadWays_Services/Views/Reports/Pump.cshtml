@model RR_RoadWays_Services.Models.PumpModel;
@{
    ViewData["Title"] = "Pump";
}
<script>
    $(document).ready(function () {
        (function ($) {
        var opt;

        $.fn.printThis = function (options) {
            opt = $.extend({}, $.fn.printThis.defaults, options);

            var $element = (this instanceof jQuery) ? this : $(this);

            var strFrameName = ("printThis-" + (new Date()).getTime());

            var $iframe = $("<iframe id='" + strFrameName + "' style='display:none' src='about:blank'/>");

            if (!opt.debug) { $iframe.css({ position: "absolute", width: "0px", height: "0px", left: "-600px", top: "-600px" }); }

            $iframe.appendTo("body");

            var $doc = $("#" + strFrameName).contents();
            // allow iframe to fully render before action
            setTimeout(function () {

                // import page css
                if (opt.importCSS) {
                    $("link[rel=stylesheet]").each(function () {
                        var href = $(this).attr('href');
                        if (href) {
                            var media = $(this).attr('media') || 'all';
                            $doc.find("head").append("<link type='text/css' rel='stylesheet' href='" + href + "' media='" + media + "'>");
                        }
                    });
                }

                // add another stylesheet
                if (opt.loadCSS) {
                    $doc.find("head").append("<link type='text/css' rel='stylesheet' href='" + opt.loadCSS + "'>");

                }

                //grab outer container
                if (opt.printContainer) { $doc.find("body").append($element.outer()); }
                else { $element.each(function () { $doc.find("body").append($(this).html()); }); }

                //$doc.close();
                // print
                setTimeout(function () { ($iframe[0].contentWindow).print();}, 100);

                //removed iframe after 60 seconds
                setTimeout(
                    function () {
                        $iframe.remove();
                    },
                    (200)
                );
            }, 333);
        }


        $.fn.printThis.defaults = {
            debug: false, //show the iframe for debugging
            importCSS: true, // import page CSS
            printContainer: true, // grab outer container as well as the contents of the selector
            loadCSS: "" //path to additional css file
        };


        jQuery.fn.outer = function () {
            return $($('<div></div>').html(this.clone())).html();
        }
        })(jQuery);
    });
</script>
<div>
    @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "searchform" }))
    {
        <div class="row mt-2">
            <div class="col-12 col-md-6">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text width-100" id="inputGroup-sizing-sm">Pump</span>
                    </div>
                    @Html.DropDownListFor(model => model.PumpId, (IEnumerable<SelectListItem>)ViewBag.PumpId, "--- Select Pump ---", new { @class = "form-control", id = "PumpDropDown", required = "required" })
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text width-100" id="inputGroup-sizing-sm">Vehicle Number</span>
                    </div>
                    @Html.DropDownListFor(model => model.VehicleNumber, (IEnumerable<SelectListItem>)ViewBag.vehicleId, "--- Select Vehicle ---", new { @class = "form-control", id = "VehicleDropDown", required = "required" })

                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text width-100" id="inputGroup-sizing-sm">Start Date</span>
                    </div>
                    @Html.EditorFor(model => model.StartDate, new
                {
                    htmlAttributes = new { @class = "form-control", id = "startdate", required = "required" }
                })
                </div>
            </div>
            <div class="col-12 col-md-6">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text width-100" id="inputGroup-sizing-sm">End Date</span>
                    </div>
                    @Html.EditorFor(model => model.EndDate, new
                {
                    htmlAttributes = new { @class = "form-control", id = "enddate", required = "required" }
                })
                </div>
            </div>
            <div class="col-12 col-md-12">
                <div class="m-2 float-right">
                    <input type="button" id="searchbutton" class="btn btn-dark" value="Search" />
                    <input type="button" id="printbutton" class="btn btn-dark" value="Print" />
                </div>
            </div>
        </div>
    }
<div class="row" id="reportprint">
    <div class="col-12 col-md-12 text-center">
        <h2>Pump Report</h2>
    </div>
    <div class="col-12 col-md-6">
        <div class="input-group input-group-sm mb-3">
            <div class="input-group-prepend">
                <span class="input-group-text width-100" id="inputGroup-sizing-sm">Pump Name</span>
            </div>
            <div id="PumpName" class="ml-3 mt-1 font-weight-bold">

            </div>
        </div>
    </div>
    <div class="col-12 col-md-12">
        <table id="example" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Voucher No</th>
                    <th>Date</th>
                    <th>Vehicle Number</th>
                    <th>Litre</th>
                    <th>Rate</th>
                    <th>Amount</th>
                    <th>Oil & Others</th>
                    <th>Amount</th>
                    <th>Total</th>
                </tr>
            </thead>
        </table>
    </div>
    <div class="col-12 col-md-8 mt-3">&nbsp;</div>
    <div class="col-12 col-md-4 mt-3">
        <div class="row">
            <div class="col-12 col-md-12 mt-1">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text width-100" id="inputGroup-sizing-sm">Total Litres</span>
                    </div>
                    <div id="totalLitre" class="ml-3 mt-1 font-weight-bold">
                        0
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-12 mt-1">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text width-100" id="inputGroup-sizing-sm">Total Amount Diesel</span>
                    </div>
                    <div id="totalDiesel" class="ml-3 mt-1 font-weight-bold">
                        0
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-12 mt-1">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text width-100" id="inputGroup-sizing-sm">Total Amount</span>
                    </div>
                    <div id="totalAmount" class="ml-3 mt-1 font-weight-bold">
                        0
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
<script type="text/javascript">
    $(document).ready(function () {
        $('#PumpDropDown').change(function () {
            var catText = $('#PumpDropDown option:selected').text();
            $('#PumpName').html(catText);
        });
        $('#printbutton').click(function () {
            $('#reportprint').printThis();
        });
        $('#searchbutton').click(function () {
            if ($('#PumpDropDown option:selected').val()
                && $('#VehicleDropDown option:selected').val()
                && $('#startdate').val()
                && $('#enddate').val()) {
                var data = {
                    PumpId: $('#PumpDropDown option:selected').val(),
                    StartDate: new Date($('#startdate').val()).toLocaleDateString('en-GB'),
                    EndDate: new Date($('#enddate').val()).toLocaleDateString('en-GB'),
                    VehicleNumber: $('#VehicleDropDown option:selected').val(),
                }
                var table = $('#example').DataTable({
                    "destroy": true,
                    "searching": false,
                    "paging": false,
                    "info": false,
                    "ajax": {
                        "url": "/Reports/getPumpData",
                        "type": "post",
                        "data": data,
                        "dataSrc": function (json) {
                            //Make your callback here.
                            let amount = json.data.reduce((a, b) => a + (b['Total'] || 0), 0);
                            let litres = json.data.reduce((a, b) => a + (b['Litre'] || 0), 0);
                            let diesel = json.data.reduce((a, b) => a + (b['Amount'] || 0), 0);
                            $('#totalLitre').html(litres.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                            $('#totalDiesel').html(diesel.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                            $('#totalAmount').html(amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","));
                            return json.data;
                        }
                    },
                    "ordering": false,
                    "columns": [
                        { "data": "VoucherNumber" },
                        { "data": "Date" },
                        { "data": "Vehicle" },
                        { "data": "Litre" },
                        { "data": "Rate" },
                        { "data": "Amount" },
                        { "data": "OilAndOther" },
                        { "data": "OilAmount" },
                        { "data": "Total" },
                    ],
                    error: function (error) {
                        alert(error);
                    }
                });
            }
            else {
                alert('Please enter mandatory fields (Pump, Vehicle Number, Start Date and End Date)');
            }

        });
    });

</script>

